<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<title>WIN WIN GRAM</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
/* 
 * Glassmorphism Red-Green Theme
 */
:root {
    --color-red: #ff3366;
    --color-green: #33ff99;
    --color-dark: #0f0f14;
    --color-text: #f0f0f5;
    --color-muted: rgba(255, 255, 255, 0.6);
    --accent-gradient: linear-gradient(135deg, var(--color-green) 0%, var(--color-red) 100%);
    --glass-bg: rgba(255, 255, 255, 0.08);
}

* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

body, html {
    margin: 0; padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--color-dark); 
    color: var(--color-text);
    height: 100%; width: 100%;
    overflow: hidden; 
    display: flex; justify-content: center; align-items: center;
}

body::before {
    content: ''; position: fixed; top: -50%; left: -50%; width: 200%; height: 200%; z-index: -1; opacity: 0.45; 
    background: radial-gradient(circle at 50% 50%, var(--color-green) 0%, var(--color-red) 25%, var(--color-dark) 50%);
    background-size: 400% 400%; animation: move-aura 30s ease infinite alternate;
}
@keyframes move-aura { 0% { background-position: 0% 0%; } 100% { background-position: 100% 100%; } }

.chat-wrapper {
    width: 95%; max-width: 600px; height: 90vh;
    border-radius: 24px; display: flex; flex-direction: column; overflow: hidden;
    background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.18); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    position: relative;
}

.chat-header {
    padding: 20px; background: var(--accent-gradient); font-size: 24px; font-weight: 900;
    text-align: center; color: white; text-shadow: 0 0 5px rgba(0,0,0,0.4); letter-spacing: 2px; flex-shrink: 0;
}

#pinnedMessageBar {
    padding: 10px 15px; background: rgba(255, 255, 255, 0.15); border-bottom: 2px solid var(--color-green);
    display: none; align-items: center; justify-content: space-between; font-size: 14px; color: var(--color-text);
    flex-shrink: 0; gap: 10px; cursor: pointer;
}
#pinnedMessageBar .pin-content { flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

.chat-body {
    flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px;
}
.chat-body::-webkit-scrollbar { width: 6px; }
.chat-body::-webkit-scrollbar-thumb { background-color: var(--color-green); border-radius: 4px; }

.message {
    max-width: 80%; padding: 12px 16px; border-radius: 20px; line-height: 1.6; word-wrap: break-word; font-size: 15px;
    cursor: pointer; position: relative; transition: transform 0.1s;
}
.user {
    background: var(--accent-gradient); margin-right: auto; border-bottom-right-radius: 4px; color: white;
    display: flex; flex-direction: column; align-items: flex-end;
}
.bot { background: rgba(255, 255, 255, 0.1); margin-left: auto; border-bottom-left-radius: 4px; }

.message-status { font-size: 12px; margin-top: 4px; color: rgba(255,255,255,0.7); align-self: flex-end; }
.message img { max-width: 100%; margin-top: 8px; border-radius: 12px; display: block; }

/* Ø§Ø³ØªØ§ÛŒÙ„ Ú©Ø§Ø¯Ø± Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ (Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡ Ø¨Ù‡ ØªÙ… Ø´Ù…Ø§) */
#preview-container {
    display: none; /* Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ù…Ø®ÙÛŒ */
    padding: 10px 15px;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(10px);
    border-top: 1px solid rgba(255,255,255,0.1);
    align-items: center; gap: 15px;
    animation: slideUp 0.3s ease;
}
@keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
#preview-thumb { height: 60px; width: auto; border-radius: 8px; border: 2px solid var(--color-green); }
.preview-info { flex: 1; font-size: 12px; color: #ccc; }
.close-preview {
    background: rgba(255,50,50,0.8); color: white; border: none; width: 24px; height: 24px;
    border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
}

.chat-input {
    padding: 15px; background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(15px);
    display: flex; gap: 10px; align-items: center; border-top: 1px solid rgba(255, 255, 255, 0.1); flex-shrink: 0;
}
.chat-input input[type="text"] {
    flex: 1; padding: 12px 16px; border-radius: 18px; border: none; outline: none;
    background: rgba(255, 255, 255, 0.15); color: var(--color-text); font-size: 16px;
}
.icon-btn {
    background: rgba(255, 255, 255, 0.15); border: none; color: white; font-size: 20px; padding: 10px;
    border-radius: 50%; cursor: pointer; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;
}
.send-btn {
    background: var(--accent-gradient); border: none; padding: 0 20px; border-radius: 20px; color: white;
    cursor: pointer; font-size: 20px; height: 45px; display: flex; align-items: center; justify-content: center; transform: scaleX(-1);
}

#contextMenu {
    position: fixed; z-index: 2000; min-width: 160px; border-radius: 12px; padding: 5px 0;
    background: rgba(30, 30, 35, 0.95); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 4px 15px rgba(0,0,0,0.5); visibility: hidden; opacity: 0; transition: 0.2s;
}
.menu-item { padding: 12px 15px; font-size: 14px; cursor: pointer; color: white; display: flex; gap: 10px; }
.menu-item:hover { background: rgba(255, 255, 255, 0.15); }
.menu-item.danger { color: #ff4444; }

@media (max-width: 768px) {
    .chat-wrapper { width: 100%; height: 100%; height: 100dvh; border-radius: 0; border: none; max-width: none; }
    .chat-header { padding-top: max(15px, env(safe-area-inset-top)); }
    .chat-input { padding-bottom: max(15px, env(safe-area-inset-bottom)); }
}
</style>
</head>

<body>

<div class="chat-wrapper">
    <div class="chat-header">WIN WIN GRAM</div>
    
    <div id="pinnedMessageBar" onclick="scrollToPinned()"></div>

    <div class="chat-body" id="chatBody">
        <div class="message bot">
            <div class="message-content">Ø³Ù„Ø§Ù…! Ù…Ù† Ø¢Ù…Ø§Ø¯Ù‡ Ú¯ÙØªÚ¯Ùˆ Ù‡Ø³ØªÙ….</div>
        </div>
    </div>

    <!-- Ú©Ø§Ù†ØªÛŒÙ†Ø± Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ (Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡) -->
    <div id="preview-container">
        <img id="preview-thumb" src="" alt="Preview">
        <div class="preview-info">Ø¹Ú©Ø³ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯.<br>Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ù…ØªÙ† Ù‡Ù… Ø¨Ù†ÙˆÛŒØ³ÛŒ.</div>
        <button class="close-preview" onclick="cancelImage()">âœ•</button>
    </div>

    <div class="chat-input">
        <input type="file" id="imgInput" accept="image/*" hidden onchange="handleImageSelect(event)">
        <button class="icon-btn" onclick="imgInput.click()" title="Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³">ğŸ“·</button>
        
        <input type="text" id="textInput" placeholder="Ù¾ÛŒØ§Ù…..." dir="rtl">
        <button class="send-btn" id="sendBtn" onclick="sendMessage()">â¤</button>
    </div>
</div>

<div id="contextMenu"></div>

<script>
// ==========================================
// ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ (Pollinations Logic)
// ==========================================
const SYSTEM_PROMPT = "You are a helpful assistant talking in Persian (Farsi). Always answer in Farsi.";
let chatHistory = [{ role: "system", content: SYSTEM_PROMPT }];
let pendingImageBase64 = null; // Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù…ÙˆÙ‚Øª Ø¹Ú©Ø³

function getRandomSeed() { return Math.floor(Math.random() * 10000000); }

async function callAI(userText, base64Image = null) {
    const typingMsg = addMessage("Ø¯Ø± Ø­Ø§Ù„ Ù†ÙˆØ´ØªÙ†...", "bot");
    
    const newMessage = { role: "user", content: "" };
    if (base64Image) {
        newMessage.content = [
            { type: "text", text: userText || "ØªØ­Ù„ÛŒÙ„ ØªØµÙˆÛŒØ±" },
            { type: "image_url", image_url: { url: base64Image } }
        ];
    } else {
        newMessage.content = userText;
    }
    
    if (chatHistory.length > 10) chatHistory = [chatHistory[0], ...chatHistory.slice(-9)];
    chatHistory.push(newMessage);

    try {
        const response = await fetch('https://text.pollinations.ai/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                messages: chatHistory,
                seed: getRandomSeed(),
                model: 'openai'
            })
        });

        if (!response.ok) throw new Error("AI Error");
        const aiText = await response.text();
        
        typingMsg.remove(); 
        
        if (aiText) {
            addMessage(aiText, "bot");
            chatHistory.push({ role: "assistant", content: aiText });
            const lastUserStatus = document.querySelector('.message.user:last-of-type .message-status');
            if(lastUserStatus) lastUserStatus.innerHTML = 'âœ”âœ”';
        }
    } catch (error) {
        typingMsg.remove();
        addMessage("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±.", "bot");
        console.error(error);
    }
}

// ==========================================
// Ù…ØªØºÛŒØ±Ù‡Ø§ Ùˆ ØªÙˆØ§Ø¨Ø¹ UI
// ==========================================
const chatBody = document.getElementById("chatBody");
const textInput = document.getElementById("textInput");
const imgInput = document.getElementById("imgInput");
const contextMenu = document.getElementById("contextMenu");
const pinnedBar = document.getElementById("pinnedMessageBar"); 
const previewContainer = document.getElementById("preview-container");
const previewThumb = document.getElementById("preview-thumb");
let activeMessage = null; 

function scrollToBottom() { chatBody.scrollTop = chatBody.scrollHeight; }

function scrollToPinned() {
    const pinnedMsg = document.querySelector('.message[data-is-pinned="true"]');
    if (pinnedMsg) pinnedMsg.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function addMessage(content, type) {
    const div = document.createElement("div");
    div.className = "message " + type;
    const contentWrapper = document.createElement('div');
    contentWrapper.className = 'message-content';
    
    if (typeof content === 'string') contentWrapper.innerHTML = content;
    else contentWrapper.appendChild(content);
    
    div.appendChild(contentWrapper);

    if (type === 'user') {
        const statusSpan = document.createElement('span');
        statusSpan.className = 'message-status';
        statusSpan.innerHTML = 'âœ”'; 
        div.appendChild(statusSpan); 
    }
    
    chatBody.appendChild(div);
    scrollToBottom();
    return div; 
}

// --- Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù†ØªØ®Ø§Ø¨ Ø¹Ú©Ø³ (Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´) ---
function handleImageSelect(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            pendingImageBase64 = e.target.result;
            // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´
            previewThumb.src = pendingImageBase64;
            previewContainer.style.display = 'flex';
            textInput.focus();
        };
        reader.readAsDataURL(file);
    }
}

// --- Ù„ØºÙˆ Ø¹Ú©Ø³ ---
function cancelImage() {
    pendingImageBase64 = null;
    imgInput.value = ""; 
    previewContainer.style.display = 'none';
    previewThumb.src = "";
}

// --- Ø§Ø±Ø³Ø§Ù„ Ù†Ù‡Ø§ÛŒÛŒ (Ù…ØªÙ† + Ø¹Ú©Ø³ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ) ---
function sendMessage() {
    const text = textInput.value.trim();
    
    // Ø§Ú¯Ø± Ù†Ù‡ Ù…ØªÙ†ÛŒ Ù‡Ø³Øª Ùˆ Ù†Ù‡ Ø¹Ú©Ø³ÛŒØŒ Ú©Ø§Ø±ÛŒ Ù†Ú©Ù†
    if (!text && !pendingImageBase64) return;

    // Ø³Ø§Ø®Øª Ù…Ø­ØªÙˆØ§ÛŒ Ù¾ÛŒØ§Ù… Ú©Ø§Ø±Ø¨Ø±
    let userContent = "";
    if (pendingImageBase64) {
        userContent += `<img src="${pendingImageBase64}" style="max-width:100%;border-radius:12px;margin-bottom:5px;">`;
    }
    if (text) {
        userContent += `<div>${text}</div>`;
    }

    // Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ú†Øª
    addMessage(userContent, "user");

    // Ø¢Ù…Ø§Ø¯Ù‡ Ø³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ AI
    const imgToSend = pendingImageBase64;
    const txtToSend = text;

    // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ
    textInput.value = "";
    cancelImage();

    // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ
    callAI(txtToSend, imgToSend);
}

// Ú©Ù„ÛŒØ¯ Ø§ÛŒÙ†ØªØ±
textInput.addEventListener("keypress", (e) => { if (e.key === "Enter") sendMessage(); });


// ==========================================
// Ù…Ù†ÙˆÛŒ Ú©Ù„ÛŒÚ© Ø±Ø§Ø³Øª (Context Menu) - Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±
// ==========================================
document.addEventListener('click', (e) => {
    if (!contextMenu.contains(e.target) && !e.target.closest('.message')) hideContextMenu();
});

chatBody.addEventListener('click', (e) => {
    const msgEl = e.target.closest('.message');
    // Ø§Ø¬Ø§Ø²Ù‡ Ú©Ù„ÛŒÚ© Ø±Ø§Ø³Øª Ø­ØªÛŒ Ø±ÙˆÛŒ Ø¹Ú©Ø³ (Ø¨Ø§ Ø¨Ø±Ø¯Ø§Ø´ØªÙ† Ø´Ø±Ø· tagName !== 'IMG')
    if (msgEl) showContextMenu(e, msgEl); 
    else hideContextMenu();
});

// Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ù…ÙˆØ¨Ø§ÛŒÙ„ (Long Press) Ø¨Ø±Ø§ÛŒ Ù…Ù†Ùˆ
let touchTimer;
chatBody.addEventListener('touchstart', (e) => {
    const msgEl = e.target.closest('.message');
    if(msgEl) touchTimer = setTimeout(() => showContextMenu(e, msgEl), 600);
});
chatBody.addEventListener('touchend', () => clearTimeout(touchTimer));

function hideContextMenu() {
    contextMenu.style.opacity = 0; contextMenu.style.visibility = 'hidden'; activeMessage = null;
}

function showContextMenu(e, messageElement) {
    activeMessage = messageElement;
    contextMenu.innerHTML = ''; 

    contextMenu.appendChild(createMenuItem("â†©ï¸ Ù¾Ø§Ø³Ø®", () => replyMessage(messageElement)));
    contextMenu.appendChild(createMenuItem("ğŸ“„ Ú©Ù¾ÛŒ", () => copyMessage()));
    contextMenu.appendChild(createMenuItem("ğŸ“Œ Ù¾ÛŒÙ†", () => pinMessage(messageElement)));
    contextMenu.appendChild(document.createElement('hr'));
    contextMenu.appendChild(createMenuItem("ğŸ—‘ï¸ Ø­Ø°Ù", () => deleteMessage(messageElement), true));
    
    let x = e.clientX || (e.touches && e.touches[0].clientX);
    let y = e.clientY || (e.touches && e.touches[0].clientY);
    const menuW = 160;
    
    if (window.innerWidth < 768) { 
        const rect = messageElement.getBoundingClientRect();
        x = (window.innerWidth - menuW) / 2;
        y = rect.bottom + 10;
    } else {
        if (x + menuW > window.innerWidth) x -= menuW;
    }
    
    contextMenu.style.left = `${x}px`; 
    contextMenu.style.top = `${y}px`;
    contextMenu.style.visibility = 'visible'; contextMenu.style.opacity = 1;
}

function createMenuItem(text, action, isDanger = false) {
    const item = document.createElement('div');
    item.className = 'menu-item' + (isDanger ? ' danger' : '');
    item.innerText = text;
    item.onclick = (e) => { e.stopPropagation(); action(); hideContextMenu(); };
    return item;
}

function pinMessage(message) {
    document.querySelectorAll('.message').forEach(m => { m.style.border = ''; m.removeAttribute('data-is-pinned'); });
    message.style.border = `2px solid yellow`; message.setAttribute('data-is-pinned', 'true');
    const txt = message.innerText.substring(0, 30) || "ØªØµÙˆÛŒØ±";
    pinnedBar.innerHTML = `<span style="font-size:18px;">ğŸ“Œ</span><span class="pin-content">${txt}</span><button onclick="event.stopPropagation(); unpinMessage()" style="background:none;border:none;color:white;">âœ–ï¸</button>`;
    pinnedBar.style.display = 'flex';
}
function unpinMessage() {
    pinnedBar.style.display = 'none';
    const pinned = document.querySelector('[data-is-pinned="true"]');
    if(pinned) { pinned.style.border = ''; pinned.removeAttribute('data-is-pinned'); }
}
function replyMessage(msg) {
    textInput.value = `>>> Ù¾Ø§Ø³Ø® Ø¨Ù‡: "${msg.innerText.substring(0, 20)}..." `; textInput.focus();
}
function copyMessage() {
    if(activeMessage) navigator.clipboard.writeText(activeMessage.innerText).then(()=>alert("Ú©Ù¾ÛŒ Ø´Ø¯"));
}
function deleteMessage(msg) {
    if(msg.getAttribute('data-is-pinned')) unpinMessage();
    msg.remove();
}
</script>

</body>
</html>

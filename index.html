<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>WIN WIN GRAM</title> 
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* 
 * Glassmorphism Red-Green Theme
 */
:root {
    --color-red: #ff3366;
    --color-green: #33ff99;
    --color-dark: #0f0f14;
    --color-text: #f0f0f5;
    --color-muted: rgba(255, 255, 255, 0.6);
    --accent-gradient: linear-gradient(135deg, var(--color-green) 0%, var(--color-red) 100%);
    --glass-bg: rgba(255, 255, 255, 0.08);
}
* { box-sizing: border-box; }
body {
    margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--color-dark); color: var(--color-text); height: 100vh;
    display: flex; justify-content: center; align-items: center; direction: rtl; overflow: hidden; 
}
body::before {
    content: ''; position: fixed; top: -50%; left: -50%; width: 200%; height: 200%; z-index: -1; opacity: 0.45; 
    background: radial-gradient(circle at 50% 50%, var(--color-green) 0%, var(--color-red) 25%, var(--color-dark) 50%);
    background-size: 400% 400%; animation: move-aura 30s ease infinite alternate;
}
@keyframes move-aura {
    0% { background-position: 0% 0%; } 33% { background-position: 100% 0%; } 66% { background-position: 50% 100%; } 100% { background-position: 0% 0%; }
}
.chat-wrapper {
    width: 95%; max-width: 600px; height: 90vh; border-radius: 24px; display: flex; flex-direction: column; overflow: hidden;
    background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.18); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
}
.chat-header {
    padding: 20px; background: var(--accent-gradient); font-size: 26px; font-weight: 900;
    text-align: center; color: white; text-shadow: 0 0 5px rgba(0,0,0,0.4); letter-spacing: 2px; flex-shrink: 0;
}
#pinnedMessageBar {
    padding: 10px 15px; background: rgba(255, 255, 255, 0.15); border-bottom: 2px solid var(--color-green);
    display: none; align-items: center; justify-content: space-between; font-size: 14px; color: var(--color-text); flex-shrink: 0; gap: 10px; cursor: pointer;
}
#pinnedMessageBar .pin-content { flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding-inline-end: 10px; }
#pinnedMessageBar button { background: none; border: none; color: var(--color-muted); font-size: 18px; cursor: pointer; padding: 0; flex-shrink: 0; }
#pinnedMessageBar button:hover { color: var(--color-red); }
.chat-body { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
.chat-body::-webkit-scrollbar { width: 8px; }
.chat-body::-webkit-scrollbar-thumb { background-color: var(--color-green); border-radius: 4px; }
.chat-body::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.1); }
.message {
    max-width: 75%; padding: 14px 18px; border-radius: 20px; line-height: 1.6; word-wrap: break-word; font-size: 15px;
    cursor: pointer; position: relative; transition: transform 0.1s, border 0.3s, box-shadow 0.3s;
}
.message:hover { transform: scale(1.01); }
.user {
    background: var(--accent-gradient); margin-right: auto; border-bottom-right-radius: 4px; color: white;
    display: flex; flex-direction: column; align-items: flex-end; 
}
.user .message-content { width: 100%; }
.bot { background: rgba(255, 255, 255, 0.1); margin-left: auto; border-bottom-left-radius: 4px; color: var(--color-text); }
.message-status {
    font-size: 14px; margin-top: 5px; margin-inline-start: 5px; color: rgba(255, 255, 255, 0.7);
    display: block; line-height: 1; font-family: Arial, sans-serif; font-weight: bold; align-self: flex-end; transition: color 0.5s;
}
.message.user .message-status[data-status="read"] { color: var(--color-green); }
.message img { max-width: 100%; margin-top: 8px; border-radius: 12px; display: block; }

/* 
 * Ø§ØµÙ„Ø§Ø­ÛŒÙ‡ Ù†ÙˆØ§Ø± ÙˆØ±ÙˆØ¯ÛŒ (ÙØ´Ø±Ø¯Ù‡â€ŒØªØ± Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ù‡ØªØ± Ø¯Ú©Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„) 
 */
.chat-input {
    padding: 8px 10px; /* Ú©Ø§Ù‡Ø´ Ù¾Ø¯ÛŒÙ†Ú¯ */
    background: rgba(0, 0, 0, 0.2); backdrop-filter: blur(15px); 
    display: flex; gap: 8px; align-items: center; border-top: 1px solid rgba(255, 255, 255, 0.1); flex-shrink: 0;
}
.chat-input input[type="text"] {
    flex: 1; padding: 10px 14px; /* ÙÛŒÙ„Ø¯ Ú©ÙˆÚ†Ú©â€ŒØªØ± */
    border-radius: 18px; border: none; outline: none;
    background: rgba(255, 255, 255, 0.15); color: var(--color-text); font-size: 15px; transition: background 0.3s; box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3);
}
.chat-input input[type="text"]::placeholder { color: var(--color-muted); }
.chat-input input[type="text"]:focus { background: rgba(255, 255, 255, 0.25); }
.icon-btn {
    background: rgba(255, 255, 255, 0.15); border: none; color: white; font-size: 18px; padding: 8px 12px;
    border-radius: 15px; cursor: pointer; border: 1px solid rgba(255, 255, 255, 0.1); flex-shrink: 0;
}
.icon-btn:hover { background: rgba(255, 255, 255, 0.25); }
.send-btn {
    background: var(--accent-gradient); border: none; padding: 10px 16px; border-radius: 18px; color: white;
    cursor: pointer; font-weight: bold; box-shadow: 0 0 15px rgba(51, 255, 153, 0.7); transition: transform 0.2s; transform: scaleX(-1); flex-shrink: 0;
}
.send-btn:active { transform: scaleX(-1) scale(0.95); }

#contextMenu {
    position: absolute; z-index: 1000; min-width: 150px; border-radius: 12px; padding: 8px 0;
    background: rgba(30, 30, 35, 0.8); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    visibility: hidden; opacity: 0; transition: opacity 0.2s, visibility 0.2s;
}
.menu-item { padding: 10px 15px; font-size: 15px; cursor: pointer; color: var(--color-text); transition: background 0.1s; display: flex; align-items: center; gap: 10px; }
.menu-item:hover { background: rgba(255, 255, 255, 0.15); }
.menu-item.danger:hover { background: rgba(255, 51, 102, 0.2); }

@media (max-width: 650px) {
    body { height: auto; min-height: 100vh; align-items: flex-start; padding: 0; }
    .chat-wrapper { width: 100%; max-width: none; height: 100vh; border-radius: 0; box-shadow: none; }
    .chat-header { padding: 15px; font-size: 24px; }
    .chat-body { padding: 10px; gap: 8px; }
    .message { padding: 12px 16px; font-size: 14px; }
    #contextMenu { min-width: 140px; }
}
</style>
</head>

<body>

<div class="chat-wrapper">
    <div class="chat-header">WIN WIN GRAM</div>
    
    <div id="pinnedMessageBar" style="display: none;" onclick="scrollToPinned()"></div>

    <div class="chat-body" id="chatBody">
        <div class="message bot">
            <p class="message-content" style="margin: 0;">Ø³Ù„Ø§Ù…! Ù…Ù† Ø¢Ù…Ø§Ø¯Ù‡ Ú¯ÙØªÚ¯Ùˆ Ù‡Ø³ØªÙ…. (Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù† Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø±ÙˆÛŒ Ù¾ÛŒØ§Ù… Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯)</p>
        </div>
    </div>

    <div class="chat-input">
        <input type="file" id="imgInput" accept="image/*" hidden>
        <button class="icon-btn" onclick="imgInput.click()" title="Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³">ğŸ“·</button>
        
        <input type="text" id="textInput" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." dir="rtl">
        <button class="send-btn" id="sendBtn" title="Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…">â¤</button>
    </div>
</div>

<div id="contextMenu"></div>

<script>
// ==========================================
// ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ (Pollinations Logic)
// ==========================================
const SYSTEM_PROMPT = "You are a helpful assistant talking in Persian (Farsi). Always answer in Farsi.";
let chatHistory = [{ role: "system", content: SYSTEM_PROMPT }];

function getRandomSeed() {
    return Math.floor(Math.random() * 10000000);
}

// ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ
async function callAI(userText, base64Image = null) {
    const typingMsg = addMessage("...Ø¯Ø± Ø­Ø§Ù„ Ù†ÙˆØ´ØªÙ†", "bot");
    
    const newMessage = { role: "user", content: "" };

    if (base64Image) {
        // Ø³Ø§Ø®ØªØ§Ø± Ù…Ø®ØµÙˆØµ ÙˆÛŒÚ˜Ù† (Ù…ØªÙ† + Ø¹Ú©Ø³)
        newMessage.content = [
            { type: "text", text: userText || "Ù„Ø·ÙØ§ Ø§ÛŒÙ† ØªØµÙˆÛŒØ± Ø±Ø§ ØªØ­Ù„ÛŒÙ„ Ú©Ù†." },
            { type: "image_url", image_url: { url: base64Image } }
        ];
    } else {
        newMessage.content = userText;
    }
    
    // Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø§ÙØ¸Ù‡ (Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø´Ø¯Ù† Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯)
    if (chatHistory.length > 10) chatHistory = [chatHistory[0], ...chatHistory.slice(-9)];
    chatHistory.push(newMessage);

    try {
        const response = await fetch('https://text.pollinations.ai/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                messages: chatHistory,
                seed: getRandomSeed(),
                model: 'openai' // Ù…Ø¯Ù„ Ù‚Ø¯Ø±ØªÙ…Ù†Ø¯ Ø¨Ø±Ø§ÛŒ ÙˆÛŒÚ˜Ù† Ùˆ Ù…ØªÙ†
            })
        });

        if (!response.ok) throw new Error("Network error");
        const aiText = await response.text();
        
        typingMsg.remove(); // Ø­Ø°Ù Ù¾ÛŒØ§Ù… "Ø¯Ø± Ø­Ø§Ù„ Ù†ÙˆØ´ØªÙ†"
        
        if (aiText) {
            addMessage(aiText, "bot");
            chatHistory.push({ role: "assistant", content: aiText });
            
            // Ø¯Ùˆ ØªÛŒÚ© Ø´Ø¯Ù† Ø¢Ø®Ø±ÛŒÙ† Ù¾ÛŒØ§Ù… Ú©Ø§Ø±Ø¨Ø±
            const lastUserMsg = document.querySelector('.message.user:last-of-type .message-status');
            if(lastUserMsg) {
                lastUserMsg.setAttribute('data-status', 'read');
                lastUserMsg.innerHTML = 'âœ”âœ”';
            }
        } else {
            addMessage("Ù¾Ø§Ø³Ø®ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯.", "bot");
        }
    } catch (error) {
        typingMsg.remove();
        console.error("AI Error:", error);
        addMessage("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±.", "bot");
    }
}

// ==========================================
// Ù…ØªØºÛŒØ±Ù‡Ø§ Ùˆ ØªÙˆØ§Ø¨Ø¹ UI
// ==========================================
const chatBody = document.getElementById("chatBody");
const textInput = document.getElementById("textInput");
const imgInput = document.getElementById("imgInput");
const contextMenu = document.getElementById("contextMenu");
const pinnedBar = document.getElementById("pinnedMessageBar"); 
const sendBtn = document.getElementById("sendBtn"); 

let activeMessage = null; 

function scrollToBottom() {
    chatBody.scrollTop = chatBody.scrollHeight;
}

function scrollToPinned() {
    const pinnedMsg = document.querySelector('.message[data-is-pinned="true"]');
    if (pinnedMsg) pinnedMsg.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function addMessage(content, type) {
    const div = document.createElement("div");
    div.className = "message " + type;
    
    const contentWrapper = document.createElement('div');
    contentWrapper.className = 'message-content';
    
    if (typeof content === 'string') { 
        contentWrapper.innerText = content;
    } else if (content.tagName) {
         contentWrapper.appendChild(content); 
    }
    
    div.appendChild(contentWrapper);

    if (type === 'user') {
        const statusSpan = document.createElement('span');
        statusSpan.className = 'message-status user-status';
        statusSpan.setAttribute('data-status', 'sent'); 
        statusSpan.innerHTML = 'âœ”'; 
        div.appendChild(statusSpan); 
    }
    
    chatBody.appendChild(div);
    scrollToBottom();
    return div; 
}

// --- Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù…ØªÙ†ÛŒ (Ù…ØªØµÙ„ Ø¨Ù‡ AI) ---
function sendText() {
    const text = textInput.value.trim();
    if (!text) return;
    
    const span = document.createElement("span");
    span.innerText = text;
    addMessage(span, "user"); 
    
    textInput.value = "";
    
    // ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ
    callAI(text, null);
}

sendBtn.addEventListener("click", sendText);
sendBtn.addEventListener("touchend", (e) => {
    e.preventDefault(); 
    sendText(); 
    textInput.blur(); 
});

// --- Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³ (Ù…ØªØµÙ„ Ø¨Ù‡ Vision) ---
imgInput.addEventListener("change", () => {
    const file = imgInput.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const base64Image = e.target.result;
        
        const img = document.createElement("img");
        img.src = base64Image;
        addMessage(img, "user");
        
        imgInput.value = ''; 
        
        const caption = textInput.value.trim();
        textInput.value = '';
        callAI(caption, base64Image); // Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³ Ø¨Ù‡ AI
    }
    reader.readAsDataURL(file);
});

textInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendText(); }
});

// ==========================================
// Ù…Ù†Ø·Ù‚ Ù…Ù†ÙˆÛŒ Ú©Ù„ÛŒÚ© Ø±Ø§Ø³Øª (Ø³Ø§Ø¯Ù‡ Ø´Ø¯Ù‡)
// ==========================================
document.addEventListener('click', (e) => {
    if (contextMenu.contains(e.target) || e.target.closest('.message') || e.target.closest('#pinnedMessageBar')) return;
    hideContextMenu();
});

chatBody.addEventListener('click', (e) => {
    const messageElement = e.target.closest('.message');
    if (messageElement) {
        if (e.target.tagName === 'IMG') return; // Ø±ÙˆÛŒ Ø¹Ú©Ø³ Ù…Ù†Ùˆ Ø¨Ø§Ø² Ù†Ø´ÙˆØ¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
        showContextMenu(e, messageElement);
    } else { hideContextMenu(); }
});

function hideContextMenu() {
    contextMenu.style.opacity = 0; contextMenu.style.visibility = 'hidden'; activeMessage = null;
}

function showContextMenu(e, messageElement) {
    activeMessage = messageElement;
    const isUserMessage = messageElement.classList.contains('user');
    const rect = messageElement.getBoundingClientRect();
    
    contextMenu.innerHTML = ''; 

    // --- ÙÙ‚Ø· Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ: Ù¾Ø§Ø³Ø®ØŒ Ú©Ù¾ÛŒØŒ Ù¾ÛŒÙ†ØŒ Ø­Ø°Ù ---
    
    // 1. Ù¾Ø§Ø³Ø®
    contextMenu.appendChild(createMenuItem("â†©ï¸ Ù¾Ø§Ø³Ø®", () => replyMessage(messageElement)));
    
    // 2. Ú©Ù¾ÛŒ
    contextMenu.appendChild(createMenuItem("ğŸ“„ Ú©Ù¾ÛŒ", () => copyMessage()));
    
    // 3. Ù¾ÛŒÙ†
    contextMenu.appendChild(createMenuItem("ğŸ“Œ Ù¾ÛŒÙ†", () => pinMessage(messageElement)));
    
    contextMenu.appendChild(document.createElement('hr'));

    // 4. Ø­Ø°Ù
    contextMenu.appendChild(createMenuItem("ğŸ—‘ï¸ Ø­Ø°Ù", () => deleteMessage(messageElement), true));
    
    // ØªÙ†Ø¸ÛŒÙ… Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù†Ùˆ
    const chatWrapperRect = chatBody.parentElement.getBoundingClientRect();
    let menuX = isUserMessage ? rect.left - chatWrapperRect.left - 155 : rect.right - chatWrapperRect.left + 5;
    
    if (menuX < 10) menuX = 10;
    if (menuX + 150 > chatWrapperRect.width) menuX = chatWrapperRect.width - 160;
    
    let menuY = rect.top - chatWrapperRect.top + chatBody.scrollTop;
    if (menuY + 200 > chatBody.clientHeight) menuY = chatBody.clientHeight - 150;
    
    contextMenu.style.left = `${menuX}px`; contextMenu.style.top = `${menuY}px`;
    contextMenu.style.visibility = 'visible'; contextMenu.style.opacity = 1;
}

function createMenuItem(text, action, isDanger = false) {
    const item = document.createElement('div');
    item.className = 'menu-item' + (isDanger ? ' danger' : '');
    item.innerText = text;
    item.onclick = (e) => { e.stopPropagation(); action(); hideContextMenu(); };
    return item;
}

function unpinMessage() {
    pinnedBar.style.display = 'none'; pinnedBar.innerHTML = '';
    const currentlyPinned = document.querySelector('.message[data-is-pinned="true"]');
    if (currentlyPinned) { currentlyPinned.style.border = ''; currentlyPinned.style.boxShadow = ''; currentlyPinned.removeAttribute('data-is-pinned'); }
}

function pinMessage(message) {
    if (!message) return;
    document.querySelectorAll('.message').forEach(m => { m.style.border = ''; m.style.boxShadow = ''; m.removeAttribute('data-is-pinned'); });
    message.style.border = `2px solid yellow`; message.style.boxShadow = `0 0 10px yellow`; message.setAttribute('data-is-pinned', 'true');
    let contentText = (message.querySelector('.message-content').innerText || "ØªØµÙˆÛŒØ±").substring(0, 50);
    pinnedBar.innerHTML = `<span style="font-size: 20px;">ğŸ“Œ</span><span class="pin-content">${contentText}</span><button onclick="event.stopPropagation(); unpinMessage()">âœ–ï¸</button>`;
    pinnedBar.style.display = 'flex'; scrollToBottom();
}

function replyMessage(message) {
    const content = message.querySelector('.message-content').innerText.substring(0, 30);
    textInput.value = `>>> Ù¾Ø§Ø³Ø® Ø¨Ù‡: "${content.trim()}..."\n`; textInput.focus();
}

function copyMessage() {
    if (!activeMessage) return;
    const textToCopy = activeMessage.querySelector('.message-content').innerText || "[ØªØµÙˆÛŒØ±]";
    navigator.clipboard.writeText(textToCopy).then(() => alert("Ú©Ù¾ÛŒ Ø´Ø¯"));
}

function deleteMessage(message) {
    if (message.getAttribute('data-is-pinned') === 'true') unpinMessage();
    message.remove();
}
</script>

</body>
</html>
